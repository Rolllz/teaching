Занятие. Стенд Vagrant с NFS

Цель домашнего задания
Научиться самостоятельно развернуть сервис NFS и подключить к нему клиента.

Описание домашнего задания
    Основная часть: 
    
    - `vagrant up` должен поднимать 2 настроенных виртуальных машины (сервер NFS и клиента) без дополнительных ручных действий; - на сервере NFS должна быть подготовлена и экспортирована директория; 
    - в экспортированной директории должна быть поддиректория с именем __upload__ с правами на запись в неё; 
    - экспортированная директория должна автоматически монтироваться на клиенте при старте виртуальной машины (systemd, autofs или fstab -  любым способом); 
    - монтирование и работа NFS на клиенте должна быть организована с использованием NFSv3 по протоколу UDP; 
    - firewall должен быть включен и настроен как на клиенте, так и на сервере. 

В данном ДЗ был использован Centos 7.

После установки и запуска ОС выполняются следующие команды:

На сервере:

    yum install nfs-utils -y # устанавливаем утилиту для работы с NFS
    systemctl enable firewalld.service --now # включаем межсетевой экран
    firewall-cmd --add-service={"nfs3","rpc-bind","mountd"} --permanent && firewall-cmd --reload # включаем правила на межсетевом экране для работы NFS
    systemctl enable nfs --now # включаем службу NFS
    ss -tnplu | grep 2049 # проверяем, активен ли порт 2049
    ss -tnplu | grep 111 # проверяем, активен ли порт 111
    mkdir -p /srv/share/upload # создаем папку для шары
    chown -R nfsnobody:nfsnobody /srv/share # переназначаем владельца папки
    chmod -R 0777 /srv/share # переназначаем права доступа
    echo "/srv/share 192.168.56.11/32(rw,sync,root_squash)" > /etc/exports # экспоритруем шару для нашего клиента
    exportfs -var
    exportfs -s # проверяем правильность экспорта папки
    cd /srv/share/upload && touch check_file # переходим в папку и создаем тестовый файл

На клиенте:

    yum install -y nfs-utils # устанавливаем ту же утилиту, что и на сервер
    systemctl enable firewalld.service --now # включаем межсетевой экран
    systemctl status firewalld.service # проверяем статус службы межсетевого экрана
    echo "192.168.56.10:/srv/share/ /mnt nfs vers=3,proto=udp,noauto,x-systemd.automount 0 0" >> /etc/fstab # добавляем точку монтирования в fstab
    systemctl daemon-reload # перезагружаем службы
    systemctl restart remote-fs.target # перезагружаем службы удаленных файловых систем
    ls -al /mnt # проверяем, смонитровалась ли папка
    mount | grep mnt # проверяем правильность монитрования папки
    ls -al /mnt/upload/ # проверяем наличие тестового файла, созданного на сервере
    touch /mnt/upload/client_file # создаем тестовый файл через клиента

P.S. На Debian 12 (возможно, и в других Debian-based операционных системах) поддержка протокола UDP для NFS отключена на уровне ядра, в файле конфига ядра есть специальная строка

    CONFIG_NFS_DISABLE_UDP_SUPPORT=y

Разработчики утверждают, что в сетях с большой пропускной способностью (> 1GB/s) велика вероятность потерь с использованием протокола UDP и советуют использовать только TCP. В данной ОС использование протокола UDP возможно в качестве протокола монтирования (опция mountproto=udp). Изменение этой строчки в конфиге ядра решает проблему лишь частично, так как служба firewalld после этого не может работать с NFS 3 версии. Однако при выключенном межсетевом экране всё работает как часы.
